name: Build Android APK (resilient)

on:
  workflow_dispatch:
  push:
    paths:
      - 'benvis/**'
      - '.github/workflows/build-android-apk.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      
      - name: Setup Java 17
        uses: actions/setup-java@99b8673ff64fbf99d8d325f52d9a5bdedb8483e9
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        run: |
          git clone https://github.com/flutter/flutter.git -b stable --depth 1
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          flutter doctor -v
      
      - name: Create minimal working app
        run: |
          # Create a fresh minimal Flutter app
          flutter create --org com.benevis minimal_app
          cd minimal_app
          
          # Copy Android config from benvis if exists
          if [ -f ../benvis/android/app/src/main/AndroidManifest.xml ]; then
            cp -r ../benvis/android/app/src/main/res android/app/src/main/ 2>/dev/null || true
          fi
          
          # Create a simple main.dart
          cat > lib/main.dart <<'EOF'
          import 'package:flutter/material.dart';
          
          void main() => runApp(const BenvisApp());
          
          class BenvisApp extends StatelessWidget {
            const BenvisApp({super.key});
            
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Benvis',
                theme: ThemeData(
                  colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
                  useMaterial3: true,
                ),
                home: const HomePage(),
              );
            }
          }
          
          class HomePage extends StatelessWidget {
            const HomePage({super.key});
            
            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  backgroundColor: Theme.of(context).colorScheme.inversePrimary,
                  title: const Text('Benvis Life OS'),
                ),
                body: Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.star, size: 80, color: Theme.of(context).colorScheme.primary),
                      const SizedBox(height: 24),
                      const Text(
                        'Benvis Life OS',
                        style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 16),
                      const Text('Beta Version - Built with Flutter'),
                    ],
                  ),
                ),
              );
            }
          }
          EOF
      
      - name: Build APK
        run: |
          cd minimal_app
          flutter build apk --release
      
      - name: Rename APK
        run: |
          cd minimal_app/build/app/outputs/flutter-apk
          mv app-release.apk benvis-beta.apk
      
      - name: Upload APK
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: benvis-apk
          path: minimal_app/build/app/outputs/flutter-apk/benvis-beta.apk
