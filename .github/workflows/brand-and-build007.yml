name: Build to Benevis & Build Android APK (robust, no marketplace actions)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "android/**"
      - "lib/**"
      - "assets/**"
      - "pubspec.yaml"
      - ".github/workflows/brand-and-build.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: ${{ github.workspace }}/android-sdk
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      FLUTTER_HOME: ${{ github.workspace }}/flutter
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx3g -Dorg.gradle.daemon=false

    steps:
      # 1) Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ (Ø¨Ø¯ÙˆÙ† marketplace action)
      - name: Install system dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk curl unzip xz-utils git jq rsync

      # 2) Ú©Ù„ÙˆÙ† Ø®ÙˆØ¯ Ø±ÛŒÙ¾ÙˆØŒ Ø¨Ø¯ÙˆÙ† actions/checkout
      - name: Checkout repository (no marketplace)
        run: |
          set -eux
          git clone --depth 1 "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" repo
          cd repo
          # Ø§Ú¯Ù‡ Ø§Ø² Ø±ÙˆÛŒ Ø¨Ø±Ù†Ú† Ø§ÙˆÙ…Ø¯Ù‡ØŒ Ù‡Ù…ÙˆÙ†Ùˆ Ø¨Ú¯ÛŒØ±Ø› ÙˆÚ¯Ø±Ù†Ù‡ Ù‡Ù…ÙˆÙ† SHA.
          if [ "${{ github.ref_type }}" = "branch" ]; then
            git checkout "${{ github.ref_name }}"
          else
            git checkout "${{ github.sha }}"
          fi
          shopt -s dotglob
          rsync -a ./ "$GITHUB_WORKSPACE"/
          cd ..
          rm -rf repo

      # 3) Ù†ØµØ¨ Flutter
      - name: Install Flutter (stable)
        run: |
          set -eux
          git clone --depth 1 -b stable https://github.com/flutter/flutter.git "$FLUTTER_HOME"
          echo "$FLUTTER_HOME/bin" >> $GITHUB_PATH
          echo "$FLUTTER_HOME/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          export PATH="$FLUTTER_HOME/bin:$FLUTTER_HOME/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

      # 4) Ù†ØµØ¨ Android SDK cmdline-tools + Ø§ÙØ²ÙˆØ¯Ù† PATH (Ø±ÙØ¹ Ù‚Ø·Ø¹ÛŒ Ø®Ø·Ø§ÛŒ sdkmanager not found)
      - name: Install Android SDK (cmdline-tools)
        run: |
          set -euxo pipefail
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd /tmp
          echo "ğŸ“¦ Downloading cmdline-tools..."
          curl -sLo cmdtools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q cmdtools.zip -d cmdtools
          mkdir -p "$ANDROID_HOME/cmdline-tools/latest"
          mv cmdtools/* "$ANDROID_HOME/cmdline-tools/latest"

          # Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø¨Ù‡ PATH
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH"

          echo "ğŸ”§ Verifying sdkmanager..."
          which sdkmanager || (echo "âŒ sdkmanager not found"; ls -R "$ANDROID_HOME/cmdline-tools/latest/bin")

          echo "âœ… Accepting licenses..."
          yes | sdkmanager --licenses || true

          echo "â¬‡ï¸ Installing Android packages..."
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      # 5) Ø¯Ø±ÛŒØ§ÙØª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ùˆ Ø³Ø§Ø®Øª APK Ø±ÛŒÙ„ÛŒØ²
      - name: Flutter pub get
        run: |
          export PATH="$FLUTTER_HOME/bin:$FLUTTER_HOME/bin/cache/dart-sdk/bin:$PATH"
          flutter pub get

      - name: Build release APK
        run: |
          set -eux
          export PATH="$FLUTTER_HOME/bin:$FLUTTER_HOME/bin/cache/dart-sdk/bin:$PATH"
          flutter build apk --release
          ls -lah build/app/outputs/flutter-apk

      # 6) Ø§Ù†ØªØ´Ø§Ø± APK Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† GitHub Release Asset (Ø¨Ø¯ÙˆÙ† upload-artifact)
      - name: Publish APK as GitHub Release asset
        run: |
          set -eux
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          test -f "$APK_PATH"

          TAG="build-${{ github.run_id }}"
          RELEASE_NAME="Benevis Android APK ${TAG}"
          API="https://api.github.com"
          REPO="${{ github.repository }}"
          AUTH="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"

          # Ø§ÛŒØ¬Ø§Ø¯ Ø±ÛŒÙ„ÛŒØ²
          RESP=$(curl -s -X POST -H "$AUTH" -H "Content-Type: application/json" \
            "$API/repos/$REPO/releases" \
            -d "{\"tag_name\":\"$TAG\",\"name\":\"$RELEASE_NAME\",\"body\":\"Automated build from run ${TAG}\",\"draft\":false,\"prerelease\":false}")

          # Ø¢Ø¯Ø±Ø³ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
          UPLOAD_URL=$(echo "$RESP" | jq -r '.upload_url' | sed 's/{?name,label}//')

          # Ø¢Ù¾Ù„ÙˆØ¯ APK
          curl -s -X POST -H "$AUTH" -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"$APK_PATH" \
            "$UPLOAD_URL?name=Benevis-${TAG}.apk"

          echo "âœ… APK uploaded to Release: Benevis-${TAG}.apk"
